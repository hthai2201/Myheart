// Comprehensive Deobfuscation Utility
const fs = require("fs");

// Original string array from the obfuscation functions
function _0x28ae() {
  const t = [
    "STREAM",
    "https://github.com/Panbap/anh/blob/main/error/myheartv1a1.png?raw=true",
    "push",
    "gesturestart",
    "LinearFilter",
    "normalize",
    "domElement",
    "body",
    "hostname",
    "lifeDuration",
    "PointLight",
    "none",
    "4019739LTSFlD",
    "paths",
    "mãi yêu em",
    "imageIndex",
    "Color",
    "matrixWorld",
    "pause",
    "userData",
    "clear",
    "rgb(241, 121, 185)",
    "abs",
    "#ff149300",
    "images",
    "MeshBasicMaterial",
    "Heartlove",
    "beginPath",
    "userAgent",
    "CanvasTexture",
    "#ff9090",
    "DoubleSide",
    "twinkleSpeed",
    "getAzimuthalAngle",
    "textBaseline",
    "filter",
    "lookAt",
    "multiplyScalar",
    "hypot",
    "splice",
    "width=device-width, initial-scale=1.0, user-scalable=no",
    "sparkles",
    "Mesh",
    "sin",
    "pointerdown",
    "appendChild",
    "needsUpdate",
    "attributes",
    "getContext",
    "pow",
    "100vw",
    "renderOrder",
    "opacity",
    "removeEventListener",
    "rgba(255,255,255,0.5)",
    "bezierCurveTo",
    "array",
    "rgba(255,255,255,1)",
    "index",
    "alpha",
    "texts",
    "delete",
    "offset",
    "strokeStyle",
    "indexOf",
    "enablePan",
    "#include <project_vertex>\\n  vAlpha = alpha;",
    "fillStyle",
    "matrixWorldInverse",
    "degToRad",
    "log",
    "geometry",
    "clone",
    "Float32BufferAttribute",
    "baseOpacity",
    "gestureend",
    "rgba(255,20,147,0)",
    "add",
    "width",
    "change",
    "addEventListener",
    "fadeStage",
    "priority",
    "acos",
    "play",
    "#ff69b400",
    "1tKVmYD",
    "sqrt",
    "applyMatrix4",
    "getDelta",
    "wrapS",
    "button",
    "update",
    "4427220TLFwmf",
    "spawnTime",
    "damp",
    "rgba(255,255,255,0)",
    "1962124IEKwBz",
    "forEach",
    "value",
    "load",
    "Group",
    "count",
    "vertexShader",
    "fillRect",
    "setFromSphericalCoords",
    "slice",
    "offsetHSL",
    "closePath",
    "WebGLRenderer",
    "maxDistance",
    "innerText",
    "length",
    "heartColor",
    "middle",
    "catch",
    "updateMatrixWorld",
    "minDistance",
    "rotation",
    "rgba(0,0,0,0)",
    "join",
    "visible",
    "canvas",
    "gesturechange",
    "setAttribute",
    "click",
    "alphaTest",
    "preventDefault",
    "9816426BywKgu",
    "trim",
    "1130Ldyfxh",
    "aspectScale",
    "setUsage",
    "format",
    "search",
    "Scene",
    "height",
    "children",
    "radius",
    "traverse",
    "messages",
    "error",
    "isSprite",
    "devicePixelRatio",
    "magFilter",
    "scale",
    "Vector3",
    "material",
    "auto",
    "fixed",
    'bold 80px "Mali", sans-serif',
    "active",
    "Heartlove data đã được load:",
    "head",
    "repeat",
    "STAR",
    "#ffffff",
    "particleIndex",
    "text",
    "onerror",
    "font",
    "6741900MMKsYG",
    "color",
    '<i class="fas fa-volume-high"></i>',
    "style",
    "onload",
    "fa-volume-xmark",
    "uniforms",
    "life",
    "addPass",
    "varying float vAlpha;\\nvoid main(){",
    "waves",
    "crossVectors",
    "rgba(160, 30, 95, 0.9)",
    "Anh yêu em",
    "fa-volume-high",
    "lerp",
    "image",
    "Points",
    "#include <project_vertex>",
    "autoClear",
    "depthWrite",
    "creationTime",
    "includes",
    "fragmentShader",
    "size",
    "HEART",
    "strokeText",
    "setRGB",
    "cos",
    "transparent",
    "phase",
    "floor",
    "Vector2",
    "ray",
    "clientY",
    "atan2",
    "innerHeight",
    "ceil",
    "resize",
    "velocities",
    "viewport",
    "PointsMaterial",
    "MathUtils",
    "addColorStop",
    "setFromCamera",
    "from",
    "setSize",
    "setPixelRatio",
    "getPoints",
    "warn",
    "createRadialGradient",
    "min",
    "innerHTML",
    "rgb(255,192,215)",
    "random",
    "shadowColor",
    "createElement",
    "Không tìm thấy dữ liệu trong link. Sử dụng dữ liệu mặc định.",
    "DynamicDrawUsage",
    "spawnInterval",
    "clearDepth",
    "fillText",
    "textAlign",
    "copy",
    "shadowBlur",
    "updateProjectionMatrix",
    "replace",
    "2224160aelhtN",
    "arc",
    "onBeforeCompile",
    "clearRect",
    "data",
    "100%",
    "uniform float size;",
    "SHOOT",
    "parent",
    "Hệ thống đang cập nhật",
    "isActive",
    "all",
    "attribute float size; attribute float alpha; varying float vAlpha;",
    "location",
    "100vh",
    "rgba(20, 20, 20, 0.97)",
    "SpriteMaterial",
    "set",
    "#ff40c8",
    "innerWidth",
    "find",
    "BufferGeometry",
    "bold 48px Arial, sans-serif",
    "PlaneGeometry",
    "moveTo",
    "setHSL",
    "get",
    "minFilter",
    "getElapsedTime",
    "position",
    "test",
    "music",
    "parse",
    '300 70.4px "Mali","Comfortaa","Segoe UI Emoji","Noto Color Emoji","Apple Color Emoji",sans-serif',
    "block",
    "CylinderGeometry",
    '"></i>',
    "Clock",
    "void main() {",
    "remove",
    "split",
    "content",
    "enableZoom",
    "aspect",
    "map",
    "then",
    "fill",
    "has",
    "#ff69b4",
    "lineWidth",
    "65857JXalwj",
    "4Tksulf",
    "Sprite",
    "shift",
    "Tự động phát bị chặn.",
    "TextureLoader",
    "BufferAttribute",
    "AdditiveBlending",
    "8miZLrK",
    "max",
    "center",
    "querySelector",
    "Image config:",
  ];
  return (_0x28ae = function () {
    return t;
  })();
}

let shuffledArray = null;

function _0x5930(t, e) {
  if (!shuffledArray) {
    shuffledArray = _0x28ae();
  }
  return shuffledArray[(t -= 194)];
}

// Run the array shuffling logic first
function runArrayShuffling() {
  const a = _0x28ae();

  for (;;) {
    try {
      if (
        991354 ===
        (parseInt(_0x5930(407)) / 1) * (parseInt(_0x5930(418)) / 2) +
          -parseInt(_0x5930(333)) / 3 +
          (-parseInt(_0x5930(309)) / 4) * (-parseInt(_0x5930(258)) / 5) +
          parseInt(_0x5930(482)) / 6 +
          (parseInt(_0x5930(414)) / 7) * (-parseInt(_0x5930(316)) / 8) +
          parseInt(_0x5930(449)) / 9 +
          (-parseInt(_0x5930(451)) / 10) * (parseInt(_0x5930(308)) / 11)
      ) {
        break;
      }
      a.push(a.shift());
    } catch (t) {
      a.push(a.shift());
    }
  }

  shuffledArray = a;
  return a;
}

function deobfuscateFile(inputPath, outputPath) {
  console.log("🔧 Starting comprehensive deobfuscation...");

  // Step 1: Run array shuffling
  console.log("📚 Running array shuffling logic...");
  const shuffledArr = runArrayShuffling();
  console.log("✅ Array shuffling completed");

  // Step 2: Test key mappings
  console.log("\n🧪 Testing key mappings:");
  const testMappings = [
    { index: 271, expected: "location" },
    { index: 455, expected: "search" },
    { index: 284, expected: "get" },
    { index: 262, expected: "data" },
    { index: 290, expected: "parse" },
    { index: 347, expected: "Heartlove" },
    { index: 345, expected: "images" },
  ];

  for (const test of testMappings) {
    const actual = _0x5930(test.index);
    const status = actual === test.expected ? "✅" : "❌";
    console.log(
      `${status} _0x5930(${test.index}) = "${actual}" (expected: "${test.expected}")`
    );
  }

  // Step 3: Read and process file
  let content = fs.readFileSync(inputPath, "utf8");
  const originalSize = content.length;

  console.log("\n🔍 Analyzing obfuscated calls...");
  const obfuscatedCalls = content.match(/_0x5930\(\d+\)/g) || [];
  const uniqueIndices = new Set();

  obfuscatedCalls.forEach((call) => {
    const match = call.match(/_0x5930\((\d+)\)/);
    if (match) uniqueIndices.add(parseInt(match[1]));
  });

  console.log(`📊 Found ${obfuscatedCalls.length} _0x5930() calls`);
  console.log(`📊 Unique indices: ${uniqueIndices.size}`);

  // Step 4: Replace all _0x5930() calls
  let replacementCount = 0;

  content = content.replace(/_0x5930\((\d+)\)/g, (match, indexStr) => {
    const index = parseInt(indexStr);
    const replacement = _0x5930(index);
    replacementCount++;
    return `'${replacement}'`;
  });

  // Step 5: Fix import statements and THREE references
  console.log("\n🔧 Fixing import statements and THREE references...");
  content = content.replace(
    /import \* as _0x[a-f0-9]+ from "three"/g,
    'import * as THREE from "three"'
  );

  // Replace _0x3d167c["SomeClass"] with THREE.SomeClass
  content = content.replace(/_0x[a-f0-9]+\["([^"]+)"\]/g, "THREE.$1");
  content = content.replace(/_0x[a-f0-9]+\./g, "THREE.");
  content = content.replace(/_0x[a-f0-9]+\[/g, "THREE[");

  // Step 6: Handle conditional expressions
  console.log("🔧 Handling conditional expressions...");
  content = content.replace(
    /_0x5930\((\w+)\s*\?\s*(\d+)\s*:\s*(\d+)\)/g,
    (match, condition, trueIndex, falseIndex) => {
      const trueValue = _0x5930(parseInt(trueIndex));
      const falseValue = _0x5930(parseInt(falseIndex));
      return `${condition} ? '${trueValue}' : '${falseValue}'`;
    }
  );

  // Step 7: Remove obfuscation functions
  console.log("🧹 Removing obfuscation functions...");

  // Remove _0x28ae function
  content = content.replace(/function _0x28ae\(\)[^}]+\}[^}]*\}[^}]*\}/s, "");

  // Remove _0x5930 function
  content = content.replace(/function _0x5930\([^}]+\}[^}]*\}/s, "");

  // Remove array shuffling wrapper
  content = content.replace(
    /\{\s*const a = _0x28ae\(\);[\s\S]*?a\.push\(a\.shift\(\)\);\s*\}\s*catch[^}]+\}\s*\}\s*\}/g,
    ""
  );

  //   // Step 8: Clean up and format
  //   console.log("✨ Cleaning up code...");

  //   // Fix any remaining bracket/formatting issues
  //   content = content.replace(/\]\(\s*\]/g, "]()");
  //   content = content.replace(/\[\s*\]\s*\(/g, "](");

  // Add deobfuscation header
  content = "// Fully deobfuscated by utility\n" + content;

  // Step 9: Write output
  fs.writeFileSync(outputPath, content);
  const finalSize = content.length;

  console.log("\n🎉 Deobfuscation complete!");
  console.log(`📁 Input:  ${inputPath}`);
  console.log(`📁 Output: ${outputPath}`);
  console.log(`📊 Original size: ${originalSize.toLocaleString()} characters`);
  console.log(`📊 Final size: ${finalSize.toLocaleString()} characters`);
  console.log(`📊 Replacements made: ${replacementCount.toLocaleString()}`);

  // Final verification
  const remainingCalls = (content.match(/_0x[0-9a-f]+/g) || []).length;
  if (remainingCalls === 0) {
    console.log("✅ 100% deobfuscation success - no obfuscated calls remain!");
  } else {
    console.log(`⚠️  ${remainingCalls} obfuscated calls still remain`);
  }

  return content;
}

// Usage
if (require.main === module) {
  const inputFile =
    process.argv[2] || "/Users/luke/github/Myheart/assets/scripts.js";
  const outputFile =
    process.argv[3] || "/Users/luke/github/Myheart/assets/scripts-clean.js";

  try {
    deobfuscateFile(inputFile, outputFile);
  } catch (error) {
    console.error("❌ Deobfuscation failed:", error.message);
    process.exit(1);
  }
}

module.exports = { deobfuscateFile };
